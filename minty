"""Create class that is going to pull transactions from Mint"""

from selenium import webdriver
from selenium.webdriver.common.keys import Keys
import time
import gspread as gc
import csv
from oauth2client.service_account import ServiceAccountCredentials
import random
import glob
import os

"""
    You'll need to download the chromedriver file that matches the chrome version that you are using
    Place the driver into the same folder as your .py file
"""


class MintBot:

    def __init__(self, username, password):
        self.browserProfile = webdriver.ChromeOptions()
        self.browserProfile.add_experimental_option('prefs', {'intl.accept_languages': 'en,en_US'})
        self.driver = webdriver.Chrome(executable_path='Q:/Performance and Analytics/DIRECT_POD_2/_USER_LOCAL_REPOS/PaulBrownLocalRepo/_PersonalWorkspace/Personal Python Projects/chromedriver.exe')
        self.username = username
        self.password = password
        self.login()
        self.transactions()
        self.download()

    def login(self):
        driver = self.driver
        driver.get("https://accounts.intuit.com/index.html?offering_id=Intuit.ifs.mint&namespace_id=50000026&redirect_url=https%3A%2F%2Fmint.intuit.com%2Foverview.event%3Futm_medium%3Ddirect%26cta%3Dnav_login_dropdown%26adobe_mc%3DMCMID%253D04675441068150549043681284837924793455%257CMCAID%253D2E7BA5828503036A-4000119040000541%257CMCORGID%253D969430F0543F253D0A4C98C6%252540AdobeOrg%257CTS%253D1567660497%26ivid%3D1e2cf7a7-0b9b-4d88-95cf-abc7f846e052")
        time.sleep(random.randint(3, 4) + (random.randint(1, 2) / 10))
        user_name_elem = driver.find_element_by_xpath("//*[@id=\"ius-userid\"]")
        user_name_elem.clear()
        user_name_elem.send_keys(self.username)
        time.sleep(random.randint(3, 4) + (random.randint(1, 2) / 10))
        password_elem = driver.find_element_by_xpath("//*[@id=\"ius-password\"]")
        password_elem.clear()
        password_elem.send_keys(self.password)
        password_elem.send_keys(Keys.RETURN)
        time.sleep(random.randint(3, 4) + (random.randint(1, 2) / 10))

    def transactions(self):
        driver = self.driver
        driver.get("https://mint.intuit.com/transaction.event")
        time.sleep(random.randint(3, 4) + (random.randint(1, 2) / 10))

    def download(self):
        url = "https://mint.intuit.com/transactionDownload.event?" \
              "queryNew=&offset=0&filterType=cash&comparableType=8"
        driver = self.driver
        driver.get(url)
        time.sleep(random.randint(3, 4) + (random.randint(1, 2) / 10))


transactions = MintBot("YOUR USERNAME", "YOUR PASSWORD")

"""
    Get the DataFrame and then paste it into Google Sheets
    You'll need to get google api for Drive. Once you do
    you'll need to get the json file that contains your 
    credentials for the google drive api
"""

scope = ['https://www.googleapis.com/auth/drive']
cred = ServiceAccountCredentials.from_json_keyfile_name('credentials2.json', scope)
client = gc.authorize(cred)

sheet = client.open('Personal Finance Tables')
sheet_name = 'Transactions'

down_path = 'C:/Users/pbrown/Downloads/*'

list_of_files = glob.glob(down_path)
latest_file = max(list_of_files, key=os.path.getctime)

sheet.values_update(
    sheet_name,
    params={'valueInputOption': 'USER-ENTERED'},
    body={'values': list(csv.reader(open(latest_file)))}
)
